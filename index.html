<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我们的故事 | Our Story Archive</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js (Switching to unpkg for better CMap structure reliability) -->
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
    </script>

    <!-- Custom Config & Cursor -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            800: '#292524',
                            900: '#1c1917',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom Heart-Arrow Cursor */
        body {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none"><path d="M2 2L11 26L14.5 16.5L24 13L2 2Z" fill="black" stroke="white" stroke-width="1.5"/><path d="M16 20C16 18.5 17.5 17 19 17C20.5 17 21 18 21 18C21 18 21.5 17 23 17C24.5 17 26 18.5 26 20C26 22.5 21 26 21 26C21 26 16 22.5 16 20Z" fill="%23ef4444" stroke="white" stroke-width="1"/></svg>') 0 0, auto;
            background-color: #fafaf9;
            -webkit-font-smoothing: antialiased;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Internal Icon Definitions
        const iconPaths = {
            ChevronLeft: <path d="M15 18l-6-6 6-6" />,
            ChevronRight: <path d="M9 18l6-6-6-6" />,
            ZoomIn: <><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></>,
            ZoomOut: <><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="8" y1="11" x2="14" y2="11"></line></>,
            Upload: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></>,
            FileText: <><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>,
            Menu: <><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></>,
            Heart: <><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></>
        };

        const Icon = ({ name, size = 20, className = "" }) => {
            const paths = iconPaths[name];
            if (!paths) return null;
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths}
                </svg>
            );
        };

        const App = () => {
            const [pdfDoc, setPdfDoc] = useState(null);
            const [currentPage, setCurrentPage] = useState(1);
            const [numPages, setNumPages] = useState(0);
            const [scale, setScale] = useState(1.2);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [fileName, setFileName] = useState("正在打开回忆...");
            const [isLoading, setIsLoading] = useState(true);
            
            const canvasRef = useRef(null);
            const fileInputRef = useRef(null);
            
            const DEFAULT_PDF_URL = "paper.pdf"; 

            const loadPdf = async (source, name) => {
                setIsLoading(true);
                try {
                    // Critical Fix for Chinese Characters:
                    // Using unpkg directly for CMaps to ensure all font maps are available
                    const loadingTask = pdfjsLib.getDocument({
                        url: typeof source === 'string' ? source : undefined,
                        data: typeof source !== 'string' ? source : undefined,
                        // Pointing to the CMaps folder on unpkg
                        cMapUrl: 'https://unpkg.com/pdfjs-dist@3.11.174/cmaps/',
                        cMapPacked: true,
                        // Fallback for standard fonts
                        standardFontDataUrl: 'https://unpkg.com/pdfjs-dist@3.11.174/standard_fonts/'
                    });

                    const pdf = await loadingTask.promise;
                    setPdfDoc(pdf);
                    setNumPages(pdf.numPages);
                    setCurrentPage(1);
                    setFileName(name);
                } catch (error) {
                    console.error("Error loading PDF:", error);
                    if (typeof source !== 'string') {
                        alert("这个文件似乎无法打开，换一个试试？");
                    } else {
                         setFileName("未找到默认篇章");
                         setPdfDoc(null);
                    }
                } finally {
                    setIsLoading(false);
                }
            };

            useEffect(() => {
                loadPdf(DEFAULT_PDF_URL, "我们的故事 (paper.pdf)");
            }, []);

            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (file && file.type === 'application/pdf') {
                    const fileReader = new FileReader();
                    fileReader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        await loadPdf(typedarray, file.name);
                    };
                    fileReader.readAsArrayBuffer(file);
                }
            };

            useEffect(() => {
                if (!pdfDoc || !canvasRef.current) return;
                const renderPage = async () => {
                    try {
                        const page = await pdfDoc.getPage(currentPage);
                        const viewport = page.getViewport({ scale });
                        const canvas = canvasRef.current;
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        const renderContext = { canvasContext: context, viewport: viewport };
                        await page.render(renderContext).promise;
                    } catch (err) { console.error("Page render error:", err); }
                };
                renderPage();
            }, [pdfDoc, currentPage, scale]);

            const nextPage = () => currentPage < numPages && setCurrentPage(p => p + 1);
            const prevPage = () => currentPage > 1 && setCurrentPage(p => p - 1);
            const zoomIn = () => setScale(s => Math.min(s + 0.2, 3.0));
            const zoomOut = () => setScale(s => Math.max(s - 0.2, 0.6));

            const isDemo = !pdfDoc;

            return (
                <div className="flex h-screen w-full bg-stone-50 text-stone-800 font-sans overflow-hidden">
                    
                    {/* Sidebar */}
                    <aside 
                        className={`
                            fixed inset-y-0 left-0 z-30 w-72 bg-white/80 backdrop-blur-xl border-r border-stone-100 shadow-[2px_0_24px_rgba(0,0,0,0.02)]
                            transition-transform duration-500 ease-in-out transform
                            ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}
                            md:relative md:translate-x-0
                            ${!isSidebarOpen && 'md:!hidden'} 
                        `}
                    >
                        <div className="flex flex-col h-full p-6">
                            <div className="flex items-center space-x-3 mb-10 opacity-80">
                                <div className="w-8 h-8 bg-stone-900 rounded-lg flex items-center justify-center text-white">
                                    <Icon name="Heart" size={14} className="fill-current text-red-400" />
                                </div>
                                <span className="font-semibold tracking-wide text-sm">OUR STORY</span>
                            </div>

                            <div className="mb-8 p-4 rounded-2xl bg-stone-50 border border-stone-100">
                                <div className="flex items-start space-x-3">
                                    <Icon name="FileText" className="text-stone-400 mt-1" size={18} />
                                    <div className="overflow-hidden">
                                        <h3 className="text-xs font-bold text-stone-700 uppercase tracking-wider mb-1">当前篇章</h3>
                                        <p className="text-sm text-stone-600 truncate font-medium leading-relaxed">{fileName}</p>
                                    </div>
                                </div>
                            </div>

                            <div className="flex-1 overflow-y-auto no-scrollbar space-y-1">
                                <p className="text-xs font-bold text-stone-400 uppercase tracking-widest mb-4 px-2">时光目录</p>
                                {isDemo ? (
                                    <div className="px-3 py-2 text-xs text-stone-400 italic">等待开启...</div>
                                ) : (
                                    <>
                                        {[...Array(Math.min(numPages, 100))].map((_, i) => (
                                            <button 
                                                key={i}
                                                onClick={() => setCurrentPage(i + 1)}
                                                className={`w-full text-left px-3 py-3 rounded-xl text-sm transition-all duration-300 group flex items-center justify-between
                                                    ${currentPage === i + 1 
                                                        ? 'bg-stone-100 text-stone-900 font-medium' 
                                                        : 'text-stone-500 hover:bg-stone-50 hover:text-stone-700'
                                                    }`}
                                            >
                                                <span>第 {i + 1} 页</span>
                                                {currentPage === i + 1 && 
                                                    <div className="w-1.5 h-1.5 rounded-full bg-stone-800" />
                                                }
                                            </button>
                                        ))}
                                        {numPages > 100 && <div className="px-3 py-2 text-xs text-stone-400 italic">... 更多页</div>}
                                    </>
                                )}
                            </div>

                            <div className="pt-6 border-t border-stone-100 mt-4">
                                <input 
                                    type="file" 
                                    accept=".pdf" 
                                    ref={fileInputRef} 
                                    onChange={handleFileUpload} 
                                    className="hidden" 
                                />
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    className="w-full py-3 bg-stone-900 text-white rounded-xl text-sm font-medium hover:bg-stone-800 hover:shadow-lg hover:shadow-stone-200/50 transition-all duration-300 flex items-center justify-center space-x-2"
                                >
                                    <Icon name="Upload" size={16} />
                                    <span>{isDemo ? "珍藏瞬间" : "打开新篇章"}</span>
                                </button>
                            </div>
                        </div>
                    </aside>

                    <main className="flex-1 relative flex flex-col h-full overflow-hidden transition-all duration-500">
                        <header className="absolute top-0 left-0 right-0 z-20 flex items-center justify-between px-8 py-6 pointer-events-none">
                            <button 
                                onClick={() => setIsSidebarOpen(!isSidebarOpen)}
                                className="pointer-events-auto p-2 rounded-full bg-white/80 backdrop-blur-md shadow-sm border border-stone-100 text-stone-600 hover:text-stone-900 transition-all hover:scale-105 active:scale-95"
                            >
                                <Icon name={isSidebarOpen ? "ChevronLeft" : "Menu"} size={20} />
                            </button>

                            {!isDemo && (
                                <div className="pointer-events-auto flex items-center space-x-4 bg-white/90 backdrop-blur-xl px-2 py-2 rounded-full shadow-[0_8px_30px_rgba(0,0,0,0.04)] border border-stone-100/50 fade-in">
                                    <button onClick={prevPage} disabled={currentPage <= 1} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 disabled:opacity-30 transition-colors">
                                        <Icon name="ChevronLeft" size={18} />
                                    </button>
                                    <span className="font-medium text-sm text-stone-700 min-w-[3rem] text-center select-none tabular-nums">
                                        {currentPage} <span className="text-stone-300 px-1">/</span> {numPages}
                                    </span>
                                    <button onClick={nextPage} disabled={currentPage >= numPages} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 disabled:opacity-30 transition-colors">
                                        <Icon name="ChevronRight" size={18} />
                                    </button>
                                </div>
                            )}

                            <div className="pointer-events-auto flex items-center space-x-2 bg-white/90 backdrop-blur-xl px-2 py-2 rounded-full shadow-[0_8px_30px_rgba(0,0,0,0.04)] border border-stone-100/50">
                                <button onClick={zoomOut} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 transition-colors">
                                    <Icon name="ZoomOut" size={18} />
                                </button>
                                <button onClick={zoomIn} className="w-8 h-8 flex items-center justify-center rounded-full hover:bg-stone-100 text-stone-600 transition-colors">
                                    <Icon name="ZoomIn" size={18} />
                                </button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-auto bg-stone-50/50 flex justify-center p-8 pt-24 pb-20 scroll-smooth">
                            <div className={`transition-all duration-300 ease-out origin-top ${isLoading ? 'opacity-50 blur-sm' : 'opacity-100'}`} style={{ transform: `scale(${isDemo ? 1 : 1})` }}>
                                {isDemo ? (
                                    <div className="bg-white w-[600px] h-[850px] shadow-[0_20px_60px_-15px_rgba(0,0,0,0.05)] border border-stone-100 rounded-sm p-16 flex flex-col items-center justify-center text-center fade-in">
                                        <div className="w-16 h-16 bg-stone-50 rounded-2xl flex items-center justify-center mb-6 text-stone-300">
                                            <Icon name="Upload" size={32} />
                                        </div>
                                        <h2 className="text-2xl font-light text-stone-800 mb-4">
                                            {isLoading ? "正在读取记忆..." : "暂未找到故事篇章"}
                                        </h2>
                                        <p className="text-stone-500 max-w-xs leading-relaxed mb-8">
                                            {isLoading 
                                                ? "请稍候..." 
                                                : "请上传一份 PDF，或将名为 paper.pdf 的文件放入目录，让我们开始阅读。"}
                                        </p>
                                        {!isLoading && (
                                            <button 
                                                onClick={() => fileInputRef.current.click()}
                                                className="px-8 py-3 rounded-full border border-stone-200 text-stone-600 text-sm font-medium hover:bg-stone-50 transition-all hover:border-stone-300"
                                            >
                                                打开我们的故事
                                            </button>
                                        )}
                                    </div>
                                ) : (
                                    <div className="shadow-[0_40px_100px_-20px_rgba(0,0,0,0.08)]">
                                        <canvas ref={canvasRef} className="bg-white rounded-sm fade-in" />
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>